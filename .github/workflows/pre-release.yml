---
    name: "pre-release"
    on:
      push:
        branches:
          - "master"
    permissions:
      contents: read
    jobs:
      hardening:
        name: Harden runner
        uses: ./.github/workflows/hardening.yaml
      zap-scan:
        needs: hardening
        name: "OWASP ZAP DAST Scan"
        runs-on: ubuntu-latest
        
        services:
          postgres:
            image: postgres:14
            env:
              POSTGRES_USER: postgres
              POSTGRES_PASSWORD: POSTGRES_LOCAL_PWD
              POSTGRES_DB: copi_dev
            ports:
              - 5432:5432
            options: --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5

        steps:
          - name: Checkout repository
            uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

          - name: Install Elixir and Erlang
            uses: erlef/setup-beam@e6d7c94229049569db56a7ad5a540c051a010af9 # v1.20.4
            with:
              elixir-version: 1.18.2
              otp-version: 27.3.3
            env:
              ImageOS: ubuntu24

          - name: Cache deps
            uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
            with:
              path: copi.owasp.org/deps
              key: ${{ runner.os }}-mix-cache-${{ hashFiles('**/mix.lock') }}
              restore-keys: |
                ${{ runner.os }}-mix-cache-

          - name: Install dependencies
            working-directory: copi.owasp.org
            run: |
              mix local.hex --force
              mix local.rebar --force
              mix deps.get

          - name: Setup database
            working-directory: copi.owasp.org
            env:
              MIX_ENV: dev
            run: |
              mix ecto.create
              mix ecto.migrate

          - name: Install Node.js dependencies
            working-directory: copi.owasp.org/assets
            run: npm install

          - name: Build assets
            working-directory: copi.owasp.org
            env:
              MIX_ENV: dev
            run: mix assets.build

          - name: Start Phoenix server in background
            working-directory: copi.owasp.org
            env:
              MIX_ENV: dev
              SECRET_KEY_BASE: ${{ secrets.SECRET_KEY_BASE || 'test_secret_key_base_for_ci_only_min_64_chars_long_required_here' }}
            run: |
              mix phx.server &
              echo $! > phoenix.pid
              
          - name: Wait for application to be ready
            run: |
              echo "Waiting for Phoenix server to start..."
              timeout 60 bash -c 'until curl -f http://localhost:4000 > /dev/null 2>&1; do sleep 2; done'
              echo "Phoenix server is ready!"

          - name: Run ZAP Full Scan with AJAX Spider
            run: |
              docker run --network="host" -v $(pwd)/zap-reports:/zap/wrk/:rw \
                -t ghcr.io/zaproxy/zaproxy:stable \
                zap-full-scan.py \
                -t http://localhost:4000/games/new \
                -j \
                -r copi_dast_report.html \
                -w copi_dast_report.md \
                -J copi_dast_report.json \
                -x copi_dast_report.xml \
                -a \
                -d \
                -m 10 \
                -T 30 \
                || true

          - name: Stop Phoenix server
            if: always()
            working-directory: copi.owasp.org
            run: |
              if [ -f phoenix.pid ]; then
                kill $(cat phoenix.pid) || true
                rm phoenix.pid
              fi

          - name: Upload ZAP reports as artifacts
            if: always()
            uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
            with:
              name: zap-dast-reports
              path: zap-reports/
              retention-days: 30

          - name: Check for high-risk vulnerabilities
            if: always()
            run: |
              if [ -f zap-reports/copi_dast_report.json ]; then
                echo "Checking for high-risk vulnerabilities..."
                HIGH_RISK=$(jq '[.site[].alerts[] | select(.riskcode == "3")] | length' zap-reports/copi_dast_report.json || echo "0")
                MEDIUM_RISK=$(jq '[.site[].alerts[] | select(.riskcode == "2")] | length' zap-reports/copi_dast_report.json || echo "0")
                
                echo "High Risk Vulnerabilities: $HIGH_RISK"
                echo "Medium Risk Vulnerabilities: $MEDIUM_RISK"
                
                if [ "$HIGH_RISK" -gt "0" ]; then
                  echo "⚠️ WARNING: $HIGH_RISK high-risk vulnerabilities detected!"
                  echo "Please review the ZAP report for details."
                fi
              else
                echo "ZAP report not found, skipping vulnerability check"
              fi

      pre-release:
        needs: [hardening, zap-scan]
        name: "Pre Release"
        permissions:
          contents: write
        runs-on: ubuntu-latest
        steps:
          - name: Checkout repository
            uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
          # Set the pip environment up
          - name: Get Python
            uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
            with:
              python-version: '3.12'
              cache: 'pipenv' # caching pip dependencies
          - name: Install dependencies
            run: |
              sudo apt-get update
              sudo apt-get install -y libreoffice
              pip install -r requirements.txt --require-hashes
              pipenv install --ignore-pipfile --dev
          # Run the tests
          - name: Run unit tests
            run: pipenv run python -m unittest discover -s "tests/scripts" -p "*_utest.py"
          - name: Run integration
            run: pipenv run python -m unittest discover -s "tests/scripts" -p "*_itest.py"
          # Test coverage reports
          - name: Check test coverage - run tests
            run: pipenv run coverage run -m unittest discover -s "tests/scripts" -p "*_*test.py"
          - name: Check test coverage - generate xml
            run: |
              mkdir -p converter/coverage
              pipenv run coverage xml -o converter/coverage/cobertura.xml
          - name: Check test coverage - Report
            run: pipenv run coverage report --fail-under 85 scripts/convert*
          # Upload Code COverage for Codeclimate
          - uses: qltysh/qlty-action/coverage@a19242102d17e497f437d7466aa01b528537e899 # v2.2.0
            with:
              token: ${{ secrets.QLTY_COVERAGE_TOKEN }}
              total-parts-count: 3
              files: converter/coverage/cobertura.xml
          # Check translation tags
          - name: Check translation tags
            id: translation_check
            run: |
              pipenv run python scripts/check_translations.py > translation_check_report.md || echo "Translation issues found, continuing..."
              # Read the report content and save it as an output
              echo "TRANSLATION_REPORT<<EOF" >> $GITHUB_ENV
              cat translation_check_report.md >> $GITHUB_ENV
              echo "EOF" >> $GITHUB_ENV
          - name: Generate new output files
            run: |
              #
              # Building EoP
              mkdir -p output/eop || echo "Ignore error"
              mkdir -p output/eop/Links || echo "Ignore error"
              mkdir -p output/eop/Fonts || echo "Ignore error"
              cp -rf ./resources/templates/Links/eop output/eop/Links/
              cp -rf ./resources/templates/Fonts/Selawik/* output/eop/Fonts/
              cp -rf ./resources/templates/Fonts/OpenSans/* output/eop/Fonts/
              pipenv run python scripts/convert.py -t tarot -l en -lt deck -v 5.0 -e eop  -i ./resources/templates/eop_ver_deck_tarot_lang.idml -o ./output/eop/eop-5.0-deck-en.idml
              pipenv run python scripts/convert.py -t tarot -l es -lt deck -v 5.0 -e eop  -i ./resources/templates/eop_ver_deck_tarot_lang.idml -o ./output/eop/eop-5.0-deck-es.idml
              pipenv run python scripts/convert.py -t tarot -l en -lt instructions1 -v 5.0 -e eop  -i ./resources/templates/eop_ver_instructions1_tarot_lang.idml -o ./output/eop/1_instructionCard1.idml
              pipenv run python scripts/convert.py -t tarot -l en -lt instructions2 -v 5.0 -e eop  -i ./resources/templates/eop_ver_instructions2_tarot_lang.idml -o ./output/eop/1_instructionCard2.idml
              pipenv run python scripts/convert.py -t tarot -l en -lt strategy-cards -v 5.0 -e eop  -i ./resources/templates/eop_ver_strategy-cards_tarot_lang.idml -o ./output/eop/2_StrategyCard.idml
              pipenv run python scripts/convert.py -t tarot -l en -lt cards -v 5.0 -e eop  -i ./resources/templates/eop_ver_cards_tarot_lang.idml -o ./output/eop/3_PlayingCards.idml
              pipenv run python scripts/convert.py -t tarot -l en -lt threat-spoofing-cards -v 5.0 -e eop  -i ./resources/templates/eop_ver_threat-spoofing-cards_tarot_lang.idml -o ./output/eop/4_1THREATCARD-Spoofing.idml
              pipenv run python scripts/convert.py -t tarot -l en -lt threat-tampering-cards -v 5.0 -e eop  -i ./resources/templates/eop_ver_threat-tampering-cards_tarot_lang.idml -o ./output/eop/4_2THREATCARD-Tampering.idml
              pipenv run python scripts/convert.py -t tarot -l en -lt threat-repudation-cards -v 5.0 -e eop  -i ./resources/templates/eop_ver_threat-repudation-cards_tarot_lang.idml -o ./output/eop/4_3THREATCARD-Repudiation.idml
              pipenv run python scripts/convert.py -t tarot -l en -lt threat-infodisclosure-cards -v 5.0 -e eop  -i ./resources/templates/eop_ver_threat-infodisclosure-cards_tarot_lang.idml -o ./output/eop/4_4THREATCARD-InfoDisclosure.idml
              pipenv run python scripts/convert.py -t tarot -l en -lt threat-denialofsvc-cards -v 5.0 -e eop  -i ./resources/templates/eop_ver_threat-denialofsvc-cards_tarot_lang.idml -o ./output/eop/4_5THREATCARD-DenialofSvc.idml
              pipenv run python scripts/convert.py -t tarot -l en -lt threat-elevofpriv-cards -v 5.0 -e eop  -i ./resources/templates/eop_ver_threat-elevofpriv-cards_tarot_lang.idml -o ./output/eop/4_6THREATCARD-ElevofPriv.idml
              pipenv run python scripts/convert.py -t tarot -l en -lt about -v 5.0 -e eop  -i ./resources/templates/eop_ver_about_tarot_lang.idml -o ./output/eop/5_AboutCard.idml
              zip -r output/eop-5.0.zip output/eop
              #
              # Building Cornucopia WebApp Edition
              mkdir -p output/cornucopia_webapp || echo "Ignore error"
              mkdir -p output/cornucopia_webapp/Links || echo "Ignore error"
              mkdir -p output/cornucopia_webapp/Fonts || echo "Ignore error"
              cp -rf ./resources/templates/Links/cornucopia_webapp output/cornucopia_webapp/Links/
              cp -rf ./resources/templates/Fonts/NotoSans/* output/cornucopia_webapp/Fonts/
              #
              # Building Cornucopia MobileApp Edition
              mkdir -p output/cornucopia_mobileapp || echo "Ignore error"
              mkdir -p output/cornucopia_mobileapp/Links || echo "Ignore error"
              mkdir -p output/cornucopia_mobileapp/Fonts || echo "Ignore error"
              cp -rf ./resources/templates/Links/cornucopia_mobileapp output/cornucopia_mobileapp/Links/
              cp -rf ./resources/templates/Fonts/NotoSans/* output/cornucopia_mobileapp/Fonts/
              #
              pipenv run python scripts/convert.py -l all -lt all -t all -v 2.2 -e webapp
              pipenv run python scripts/convert.py -l en -lt all -t all -v 3.0 -e webapp
              pipenv run python scripts/convert.py -l en -lt all -t all -v 1.1 -e mobileapp
              pipenv run python scripts/convert.py -l all -lt guide -t bridge -v 2.2 -e webapp --pdf
              pipenv run python scripts/convert.py -l all -lt guide -t bridge_qr -v 2.2 -e webapp --pdf
              pipenv run python scripts/convert.py -l en -lt guide -t bridge -v 3.0 -e webapp --pdf
              pipenv run python scripts/convert.py -l en -lt guide -t bridge_qr -v 3.0 -e webapp --pdf
              #
              cp output/owasp_cornucopia_mobileapp_1.1_cards_bridge_en.idml output/owasp_cornucopia_mobileapp_1.1_cards_bridge_qr_en.idml output/owasp_cornucopia_mobileapp_1.1_cards_tarot_en.idml output/owasp_cornucopia_mobileapp_1.1_cards_tarot_qr_en.idml output/owasp_cornucopia_mobileapp_1.1_leaflet_bridge_en.idml output/owasp_cornucopia_mobileapp_1.1_leaflet_tarot_en.idml output/cornucopia_mobileapp/
              cp output/owasp_cornucopia_webapp_2.2_cards_bridge_en.idml output/owasp_cornucopia_webapp_2.2_cards_bridge_qr_en.idml output/owasp_cornucopia_webapp_2.2_cards_tarot_en.idml output/owasp_cornucopia_webapp_2.2_cards_tarot_qr_en.idml output/owasp_cornucopia_webapp_2.2_leaflet_bridge_en.idml output/owasp_cornucopia_webapp_2.2_leaflet_tarot_en.idml output/cornucopia_webapp/
              cp output/owasp_cornucopia_webapp_2.2_cards_bridge_es.idml output/owasp_cornucopia_webapp_2.2_cards_bridge_qr_es.idml output/owasp_cornucopia_webapp_2.2_cards_tarot_es.idml output/owasp_cornucopia_webapp_2.2_cards_tarot_qr_es.idml output/owasp_cornucopia_webapp_2.2_leaflet_bridge_es.idml output/owasp_cornucopia_webapp_2.2_leaflet_tarot_es.idml output/cornucopia_webapp/
              cp output/owasp_cornucopia_webapp_2.2_cards_bridge_fr.idml output/owasp_cornucopia_webapp_2.2_cards_bridge_qr_fr.idml output/owasp_cornucopia_webapp_2.2_cards_tarot_fr.idml output/owasp_cornucopia_webapp_2.2_cards_tarot_qr_fr.idml output/owasp_cornucopia_webapp_2.2_leaflet_bridge_fr.idml output/owasp_cornucopia_webapp_2.2_leaflet_tarot_fr.idml output/cornucopia_webapp/
              cp output/owasp_cornucopia_webapp_2.2_cards_bridge_nl.idml output/owasp_cornucopia_webapp_2.2_cards_bridge_qr_nl.idml output/owasp_cornucopia_webapp_2.2_cards_tarot_nl.idml output/owasp_cornucopia_webapp_2.2_cards_tarot_qr_nl.idml output/owasp_cornucopia_webapp_2.2_leaflet_bridge_nl.idml output/owasp_cornucopia_webapp_2.2_leaflet_tarot_nl.idml output/cornucopia_webapp/
              cp output/owasp_cornucopia_webapp_2.2_cards_bridge_no-nb.idml output/owasp_cornucopia_webapp_2.2_cards_bridge_qr_no-nb.idml output/owasp_cornucopia_webapp_2.2_cards_tarot_no-nb.idml output/owasp_cornucopia_webapp_2.2_cards_tarot_qr_no-nb.idml output/owasp_cornucopia_webapp_2.2_leaflet_bridge_no-nb.idml output/owasp_cornucopia_webapp_2.2_leaflet_tarot_no-nb.idml output/cornucopia_webapp/
              cp output/owasp_cornucopia_webapp_2.2_cards_bridge_pt-br.idml output/owasp_cornucopia_webapp_2.2_cards_bridge_qr_pt-br.idml output/owasp_cornucopia_webapp_2.2_cards_tarot_pt-br.idml output/owasp_cornucopia_webapp_2.2_cards_tarot_qr_pt-br.idml output/owasp_cornucopia_webapp_2.2_leaflet_bridge_pt-br.idml output/owasp_cornucopia_webapp_2.2_leaflet_tarot_pt-br.idml output/cornucopia_webapp/
              cp output/owasp_cornucopia_webapp_2.2_cards_bridge_pt-pt.idml output/owasp_cornucopia_webapp_2.2_cards_bridge_qr_pt-pt.idml output/owasp_cornucopia_webapp_2.2_cards_tarot_pt-pt.idml output/owasp_cornucopia_webapp_2.2_cards_tarot_qr_pt-pt.idml output/owasp_cornucopia_webapp_2.2_leaflet_bridge_pt-pt.idml output/owasp_cornucopia_webapp_2.2_leaflet_tarot_pt-pt.idml output/cornucopia_webapp/
              cp output/owasp_cornucopia_webapp_2.2_cards_bridge_ru.idml output/owasp_cornucopia_webapp_2.2_cards_bridge_qr_ru.idml output/owasp_cornucopia_webapp_2.2_cards_tarot_ru.idml output/owasp_cornucopia_webapp_2.2_cards_tarot_qr_ru.idml output/owasp_cornucopia_webapp_2.2_leaflet_bridge_ru.idml output/owasp_cornucopia_webapp_2.2_leaflet_tarot_ru.idml output/cornucopia_webapp/
              cp output/owasp_cornucopia_webapp_2.2_cards_bridge_it.idml output/owasp_cornucopia_webapp_2.2_cards_bridge_qr_it.idml output/owasp_cornucopia_webapp_2.2_cards_tarot_it.idml output/owasp_cornucopia_webapp_2.2_cards_tarot_qr_it.idml output/owasp_cornucopia_webapp_2.2_leaflet_bridge_it.idml output/owasp_cornucopia_webapp_2.2_leaflet_tarot_it.idml output/cornucopia_webapp/
              zip -r output/owasp_cornucopia_mobileapp_1.1_en.zip output/cornucopia_mobileapp/Links/* output/cornucopia_mobileapp/Fonts/* output/cornucopia_mobileapp/owasp_cornucopia_mobileapp_1.1_cards_bridge_en.idml output/cornucopia_mobileapp/owasp_cornucopia_mobileapp_1.1_cards_bridge_qr_en.idml output/cornucopia_mobileapp/owasp_cornucopia_mobileapp_1.1_cards_tarot_en.idml output/cornucopia_mobileapp/owasp_cornucopia_mobileapp_1.1_cards_tarot_qr_en.idml output/cornucopia_mobileapp/owasp_cornucopia_mobileapp_1.1_leaflet_bridge_en.idml output/cornucopia_mobileapp/owasp_cornucopia_mobileapp_1.1_leaflet_tarot_en.idml ./resources/templates/owasp_cornucopia_mobileapp_scoresheet.pdf
              zip -r output/owasp_cornucopia_webapp_2.2_en.zip output/cornucopia_webapp/Links/* output/cornucopia_webapp/Fonts/* output/cornucopia_webapp/owasp_cornucopia_webapp_2.2_cards_bridge_en.idml output/cornucopia_webapp/owasp_cornucopia_webapp_2.2_cards_bridge_qr_en.idml output/cornucopia_webapp/owasp_cornucopia_webapp_2.2_cards_tarot_en.idml output/cornucopia_webapp/owasp_cornucopia_webapp_2.2_cards_tarot_qr_en.idml output/cornucopia_webapp/owasp_cornucopia_webapp_2.2_leaflet_bridge_en.idml output/cornucopia_webapp/owasp_cornucopia_webapp_2.2_leaflet_tarot_en.idml ./resources/templates/owasp_cornucopia_webapp_scoresheet.pdf
              zip -r output/owasp_cornucopia_webapp_2.2_es.zip output/cornucopia_webapp/Links/* output/cornucopia_webapp/Fonts/* output/cornucopia_webapp/owasp_cornucopia_webapp_2.2_cards_bridge_es.idml output/cornucopia_webapp/owasp_cornucopia_webapp_2.2_cards_bridge_qr_es.idml output/cornucopia_webapp/owasp_cornucopia_webapp_2.2_cards_tarot_es.idml output/cornucopia_webapp/owasp_cornucopia_webapp_2.2_cards_tarot_qr_es.idml output/cornucopia_webapp/owasp_cornucopia_webapp_2.2_leaflet_bridge_es.idml output/cornucopia_webapp/owasp_cornucopia_webapp_2.2_leaflet_tarot_es.idml ./resources/templates/owasp_cornucopia_webapp_scoresheet.pdf
              zip -r output/owasp_cornucopia_webapp_2.2_fr.zip output/cornucopia_webapp/Links/* output/cornucopia_webapp/Fonts/* output/cornucopia_webapp/owasp_cornucopia_webapp_2.2_cards_bridge_fr.idml output/cornucopia_webapp/owasp_cornucopia_webapp_2.2_cards_bridge_qr_fr.idml output/cornucopia_webapp/owasp_cornucopia_webapp_2.2_cards_tarot_fr.idml output/cornucopia_webapp/owasp_cornucopia_webapp_2.2_cards_tarot_qr_fr.idml output/cornucopia_webapp/owasp_cornucopia_webapp_2.2_leaflet_bridge_fr.idml output/cornucopia_webapp/owasp_cornucopia_webapp_2.2_leaflet_tarot_fr.idml ./resources/templates/owasp_cornucopia_webapp_scoresheet.pdf
              zip -r output/owasp_cornucopia_webapp_2.2_nl.zip output/cornucopia_webapp/Links/* output/cornucopia_webapp/Fonts/* output/cornucopia_webapp/owasp_cornucopia_webapp_2.2_cards_bridge_nl.idml output/cornucopia_webapp/owasp_cornucopia_webapp_2.2_cards_bridge_qr_nl.idml output/cornucopia_webapp/owasp_cornucopia_webapp_2.2_cards_tarot_nl.idml output/cornucopia_webapp/owasp_cornucopia_webapp_2.2_cards_tarot_qr_nl.idml output/cornucopia_webapp/owasp_cornucopia_webapp_2.2_leaflet_bridge_nl.idml output/cornucopia_webapp/owasp_cornucopia_webapp_2.2_leaflet_tarot_nl.idml ./resources/templates/owasp_cornucopia_webapp_scoresheet.pdf
              zip -r output/owasp_cornucopia_webapp_2.2_no-nb.zip output/cornucopia_webapp/Links/* output/cornucopia_webapp/Fonts/* output/cornucopia_webapp/owasp_cornucopia_webapp_2.2_cards_bridge_no-nb.idml output/cornucopia_webapp/owasp_cornucopia_webapp_2.2_cards_bridge_qr_no-nb.idml output/cornucopia_webapp/owasp_cornucopia_webapp_2.2_cards_tarot_no-nb.idml output/cornucopia_webapp/owasp_cornucopia_webapp_2.2_cards_tarot_qr_no-nb.idml output/cornucopia_webapp/owasp_cornucopia_webapp_2.2_leaflet_bridge_no-nb.idml output/cornucopia_webapp/owasp_cornucopia_webapp_2.2_leaflet_tarot_no-nb.idml ./resources/templates/owasp_cornucopia_webapp_scoresheet.pdf
              zip -r output/owasp_cornucopia_webapp_2.2_pt-br.zip output/cornucopia_webapp/Links/* output/cornucopia_webapp/Fonts/* output/cornucopia_webapp/owasp_cornucopia_webapp_2.2_cards_bridge_pt-br.idml output/cornucopia_webapp/owasp_cornucopia_webapp_2.2_cards_bridge_qr_pt-br.idml output/cornucopia_webapp/owasp_cornucopia_webapp_2.2_cards_tarot_pt-br.idml output/cornucopia_webapp/owasp_cornucopia_webapp_2.2_cards_tarot_qr_pt-br.idml output/cornucopia_webapp/owasp_cornucopia_webapp_2.2_leaflet_bridge_pt-br.idml output/cornucopia_webapp/owasp_cornucopia_webapp_2.2_leaflet_tarot_pt-br.idml ./resources/templates/owasp_cornucopia_webapp_scoresheet.pdf
              zip -r output/owasp_cornucopia_webapp_2.2_pt-pt.zip output/cornucopia_webapp/Links/* output/cornucopia_webapp/Fonts/* output/cornucopia_webapp/owasp_cornucopia_webapp_2.2_cards_bridge_pt-pt.idml output/cornucopia_webapp/owasp_cornucopia_webapp_2.2_cards_bridge_qr_pt-pt.idml output/cornucopia_webapp/owasp_cornucopia_webapp_2.2_cards_tarot_pt-pt.idml output/cornucopia_webapp/owasp_cornucopia_webapp_2.2_cards_tarot_qr_pt-pt.idml output/cornucopia_webapp/owasp_cornucopia_webapp_2.2_leaflet_bridge_pt-pt.idml output/cornucopia_webapp/owasp_cornucopia_webapp_2.2_leaflet_tarot_pt-pt.idml ./resources/templates/owasp_cornucopia_webapp_scoresheet.pdf
              zip -r output/owasp_cornucopia_webapp_2.2_ru.zip output/cornucopia_webapp/Links/* output/cornucopia_webapp/Fonts/* output/cornucopia_webapp/owasp_cornucopia_webapp_2.2_cards_bridge_ru.idml output/cornucopia_webapp/owasp_cornucopia_webapp_2.2_cards_bridge_qr_ru.idml output/cornucopia_webapp/owasp_cornucopia_webapp_2.2_cards_tarot_ru.idml output/cornucopia_webapp/owasp_cornucopia_webapp_2.2_cards_tarot_qr_ru.idml output/cornucopia_webapp/owasp_cornucopia_webapp_2.2_leaflet_bridge_ru.idml output/cornucopia_webapp/owasp_cornucopia_webapp_2.2_leaflet_tarot_ru.idml ./resources/templates/owasp_cornucopia_webapp_scoresheet.pdf
              zip -r output/owasp_cornucopia_webapp_2.2_it.zip output/cornucopia_webapp/Links/* output/cornucopia_webapp/Fonts/* output/cornucopia_webapp/owasp_cornucopia_webapp_2.2_cards_bridge_it.idml output/cornucopia_webapp/owasp_cornucopia_webapp_2.2_cards_bridge_qr_it.idml output/cornucopia_webapp/owasp_cornucopia_webapp_2.2_cards_tarot_it.idml output/cornucopia_webapp/owasp_cornucopia_webapp_2.2_cards_tarot_qr_it.idml output/cornucopia_webapp/owasp_cornucopia_webapp_2.2_leaflet_bridge_it.idml output/cornucopia_webapp/owasp_cornucopia_webapp_2.2_leaflet_tarot_it.idml ./resources/templates/owasp_cornucopia_webapp_scoresheet.pdf

              cp output/owasp_cornucopia_webapp_3.0_cards_bridge_en.idml output/owasp_cornucopia_webapp_3.0_cards_bridge_qr_en.idml output/owasp_cornucopia_webapp_3.0_cards_tarot_en.idml output/owasp_cornucopia_webapp_3.0_cards_tarot_qr_en.idml output/owasp_cornucopia_webapp_3.0_leaflet_bridge_en.idml output/owasp_cornucopia_webapp_3.0_leaflet_tarot_en.idml output/cornucopia_webapp/
              zip -r output/owasp_cornucopia_webapp_3.0_en.zip output/cornucopia_webapp/Links/* output/cornucopia_webapp/Fonts/* output/cornucopia_webapp/owasp_cornucopia_webapp_3.0_cards_bridge_en.idml output/cornucopia_webapp/owasp_cornucopia_webapp_3.0_cards_bridge_qr_en.idml output/cornucopia_webapp/owasp_cornucopia_webapp_3.0_cards_tarot_en.idml output/cornucopia_webapp/owasp_cornucopia_webapp_3.0_cards_tarot_qr_en.idml output/cornucopia_webapp/owasp_cornucopia_webapp_3.0_leaflet_bridge_en.idml output/cornucopia_webapp/owasp_cornucopia_webapp_3.0_leaflet_tarot_en.idml ./resources/templates/owasp_cornucopia_webapp_scoresheet.pdf
          - name: Prepare release body with translation report
            id: prepare_release
            run: |
              # Read the translation report
              TRANSLATION_REPORT=$(cat translation_check_report.md)
              # Create a combined release body
              cat > release_body.md << 'EOF'
              ## OWASP Cornucopia Pre-Release
              
              This is an automated pre-release build from the latest master branch.
              
              ---
              
              EOF
              cat translation_check_report.md >> release_body.md
          - name: Delete existing release and tag
            run: gh release delete "pre-release" --cleanup-tag -y
            env:
              GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            continue-on-error: true
          - uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
            name: "Create pre-release"
            with:
              draft: false
              tag_name: pre-release
              prerelease: true
              name: Latest pre-release
              body_path: release_body.md
              files: |
                CHANGELOG.md
                LICENSE.md
                LICENSE-CC-BY-SA-3.0.md
                README.md
                creative-commons-attribution-3.0.txt
                output/eop-5.0.zip
                output/owasp_cornucopia_mobileapp_1.1_en.zip
                output/owasp_cornucopia_webapp_2.2_en.zip
                output/owasp_cornucopia_webapp_2.2_es.zip
                output/owasp_cornucopia_webapp_2.2_fr.zip
                output/owasp_cornucopia_webapp_2.2_it.zip
                output/owasp_cornucopia_webapp_2.2_nl.zip
                output/owasp_cornucopia_webapp_2.2_no-nb.zip
                output/owasp_cornucopia_webapp_2.2_pt-br.zip
                output/owasp_cornucopia_webapp_2.2_pt-pt.zip
                output/owasp_cornucopia_webapp_2.2_ru.zip
                output/owasp_cornucopia_webapp_2.2_guide_bridge_en.odt
                output/owasp_cornucopia_webapp_2.2_guide_bridge_es.odt
                output/owasp_cornucopia_webapp_2.2_guide_bridge_fr.odt
                output/owasp_cornucopia_webapp_2.2_guide_bridge_it.odt
                output/owasp_cornucopia_webapp_2.2_guide_bridge_nl.odt
                output/owasp_cornucopia_webapp_2.2_guide_bridge_no-nb.odt
                output/owasp_cornucopia_webapp_2.2_guide_bridge_pt-br.odt
                output/owasp_cornucopia_webapp_2.2_guide_bridge_pt-pt.odt
                output/owasp_cornucopia_webapp_2.2_guide_bridge_ru.odt
                output/owasp_cornucopia_webapp_2.2_guide_bridge_qr_en.odt
                output/owasp_cornucopia_webapp_2.2_guide_bridge_qr_es.odt
                output/owasp_cornucopia_webapp_2.2_guide_bridge_qr_fr.odt
                output/owasp_cornucopia_webapp_2.2_guide_bridge_qr_it.odt
                output/owasp_cornucopia_webapp_2.2_guide_bridge_qr_nl.odt
                output/owasp_cornucopia_webapp_2.2_guide_bridge_qr_no-nb.odt
                output/owasp_cornucopia_webapp_2.2_guide_bridge_qr_pt-br.odt
                output/owasp_cornucopia_webapp_2.2_guide_bridge_qr_pt-pt.odt
                output/owasp_cornucopia_webapp_2.2_guide_bridge_qr_ru.odt
                output/owasp_cornucopia_webapp_2.2_guide_bridge_en.pdf
                output/owasp_cornucopia_webapp_2.2_guide_bridge_es.pdf
                output/owasp_cornucopia_webapp_2.2_guide_bridge_fr.pdf
                output/owasp_cornucopia_webapp_2.2_guide_bridge_it.pdf
                output/owasp_cornucopia_webapp_2.2_guide_bridge_nl.pdf
                output/owasp_cornucopia_webapp_2.2_guide_bridge_no-nb.pdf
                output/owasp_cornucopia_webapp_2.2_guide_bridge_pt-br.pdf
                output/owasp_cornucopia_webapp_2.2_guide_bridge_pt-pt.pdf
                output/owasp_cornucopia_webapp_2.2_guide_bridge_ru.pdf
                output/owasp_cornucopia_webapp_2.2_guide_bridge_qr_en.pdf
                output/owasp_cornucopia_webapp_2.2_guide_bridge_qr_es.pdf
                output/owasp_cornucopia_webapp_2.2_guide_bridge_qr_fr.pdf
                output/owasp_cornucopia_webapp_2.2_guide_bridge_qr_it.pdf
                output/owasp_cornucopia_webapp_2.2_guide_bridge_qr_nl.pdf
                output/owasp_cornucopia_webapp_2.2_guide_bridge_qr_no-nb.pdf
                output/owasp_cornucopia_webapp_2.2_guide_bridge_qr_pt-br.pdf
                output/owasp_cornucopia_webapp_2.2_guide_bridge_qr_pt-pt.pdf
                output/owasp_cornucopia_webapp_2.2_guide_bridge_qr_ru.pdf
                output/owasp_cornucopia_webapp_3.0_guide_bridge_en.odt
                output/owasp_cornucopia_webapp_3.0_guide_bridge_en.pdf
                output/owasp_cornucopia_webapp_3.0_guide_bridge_qr_en.odt
                output/owasp_cornucopia_webapp_3.0_guide_bridge_qr_en.pdf
                resources/case/*\2.2_case_*
                resources/case/*\1.1_case_*
                source/*1\.1-*.yaml
                source/*2\.2-*.yaml
                output/owasp_cornucopia_webapp_3.0_en.zip
                zap-reports/copi_dast_report.html
                zap-reports/copi_dast_report.json
                zap-reports/copi_dast_report.xml
                zap-reports/copi_dast_report.md
